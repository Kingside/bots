<!DOCTYPE html>  <html> <head>   <title>bots.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               bots.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The main <code>Bot</code> class that all robots are created from, this contains the
main functions for assembling a bot.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">EventEmitter</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;events&#39;</span>
<span class="nv">http = </span><span class="nx">require</span> <span class="s1">&#39;http&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Factory method for creating a new <code>Bot</code> instance. Accepts a name
argument, which is the name given to the bot.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.createBot = </span><span class="nf">(name) -&gt;</span>
  <span class="k">new</span> <span class="nx">Bot</span> <span class="nx">name</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The <code>Bot</code> class, inherits from <code>EventEmitter</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Bot = </span><span class="k">class</span> <span class="nx">Bot</span> <span class="k">extends</span> <span class="nx">EventEmitter</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Creates a new <code>Bot</code> with the given name. Sets up the bot ready to be
configured.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@name) -&gt;</span>
    <span class="vi">@handlers = </span><span class="p">[]</span>
    <span class="vi">@interfaces = </span><span class="p">[]</span>
    <span class="vi">@descriptions = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Adds a description of a piece of the robots functionality, this is used
for the robots builtin <code>help</code> phrase.</p>

<p><code>phrase</code> - The String representing the phase the bot recognises.
<code>functionality</code> - The String describing the result of the phrase.</p>

<pre><code>bot.desc('image me THING', 'Get a random image of THING');
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">desc: </span><span class="p">(</span><span class="nx">phrase</span><span class="p">,</span> <span class="nx">functionality</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@descriptions</span><span class="p">[</span><span class="nx">phrase</span><span class="p">]</span> <span class="o">=</span> <span class="nx">functionality</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Add a <code>pattern</code> to the robots repotoire. This is matched against incoming
messages and if they match then the message is passed to <code>callback</code>.</p>

<p><code>pattern</code> - The RegEx to match against the message body.
<code>callback</code> - The Function to be invoked when the pattern is matched.</p>

<pre><code>bot.hear(/ping/, function(message) {
  message.say('PONG');
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hear: </span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@handlers</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">callback</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Add an interface to the robot. This is allows the 'bot to communicate
with the outside world. See the <code>Cli</code> and <code>XMPP</code> interfaces for examples,
the interface should inherit from EventEmitter, and emit a <code>message</code>
event when there is a new message on the interface.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">use: </span><span class="nf">(interface) -&gt;</span>
    <span class="nx">@interfaces</span><span class="p">.</span><span class="nx">push</span> <span class="nx">interface</span>
    <span class="nx">interface</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">@dispatch</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Dispatches an incoming message to any handlers that match the message
body.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">dispatch: </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">for</span> <span class="nx">pair</span> <span class="k">in</span> <span class="nx">@handlers</span>
      <span class="p">[</span> <span class="nx">pattern</span><span class="p">,</span> <span class="nx">handler</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">pair</span>
      <span class="nx">handler</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="k">if</span> <span class="nv">message.match = </span><span class="nx">message</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Start the bot up, calls listen on the registered interfaces.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">start: </span><span class="o">-&gt;</span>
    <span class="nx">@hear</span> <span class="sr">/help/</span><span class="p">,</span> <span class="nx">@help</span>
    <span class="nx">@interfaces</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(i) -&gt;</span> <span class="nx">i</span><span class="p">.</span><span class="nx">listen</span><span class="p">()</span>
    <span class="nx">@emit</span> <span class="s1">&#39;start&#39;</span>

  <span class="nv">get: </span><span class="nf">(path, body, callback) -&gt;</span>
    <span class="nx">@request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>

  <span class="nv">post: </span><span class="nf">(path, body, callback) -&gt;</span>
    <span class="nx">@request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>

  <span class="nv">help: </span><span class="nf">(message) -&gt;</span>
    <span class="nx">message</span><span class="p">.</span><span class="nx">say</span> <span class="s2">&quot;I listen for the followingâ€¦&quot;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="k">for</span> <span class="nx">phrase</span><span class="p">,</span> <span class="nx">functionality</span> <span class="k">of</span> <span class="nx">@descriptions</span>
        <span class="k">if</span> <span class="nx">functionality</span>
          <span class="nv">output = </span> <span class="nx">phrase</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nx">functionality</span>
        <span class="k">else</span>
          <span class="nv">output = </span><span class="nx">phrase</span>
        <span class="nx">message</span><span class="p">.</span><span class="nx">say</span> <span class="nx">output</span>

  <span class="nv">request: </span><span class="nf">(method, path, body, callback) -&gt;</span>
    <span class="k">if</span> <span class="nv">match = </span><span class="nx">path</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^(https?):\/\/([^\/]+?)(\/.+)/</span><span class="p">)</span>
      <span class="nv">headers = </span><span class="p">{</span> <span class="nv">Host: </span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;User-Agent&#39;</span><span class="o">:</span> <span class="nx">@name</span> <span class="p">}</span>
      <span class="nv">port = </span><span class="k">if</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;https&#39;</span> <span class="k">then</span> <span class="mi">443</span> <span class="k">else</span> <span class="mi">80</span>
      <span class="nv">client = </span><span class="nx">http</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">port</span> <span class="o">==</span> <span class="mi">443</span><span class="p">)</span>
      <span class="nv">path = </span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

      <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">callback</span>
        <span class="nv">callback = </span><span class="nx">body</span>
        <span class="nv">body = </span><span class="kc">null</span>

      <span class="k">if</span> <span class="nx">method</span> <span class="o">is</span> <span class="s1">&#39;POST&#39;</span> <span class="o">and</span> <span class="nx">body</span>
        <span class="nv">body = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">body</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">body</span> <span class="o">isnt</span> <span class="s1">&#39;string&#39;</span>
        <span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">length</span>

      <span class="nv">req = </span><span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">headers</span><span class="p">)</span>

      <span class="nx">req</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
        <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">is</span> <span class="mi">200</span>
          <span class="nv">data = </span><span class="s1">&#39;&#39;</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
          <span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
            <span class="nx">data</span> <span class="o">+=</span> <span class="nx">chunk</span>
          <span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="nx">callback</span>
              <span class="k">try</span>
                <span class="nv">body = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
              <span class="k">catch</span> <span class="nx">e</span>
                <span class="nv">body = </span><span class="nx">data</span>
              <span class="nx">callback</span> <span class="nx">body</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">is</span> <span class="mi">302</span>
          <span class="nx">request</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;#{response.statusCode}: #{path}&quot;</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
          <span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nf">(chunk) -&gt;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
          <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="k">if</span> <span class="nx">method</span> <span class="o">is</span> <span class="s1">&#39;POST&#39;</span> <span class="o">and</span> <span class="nx">body</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Interfaces</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Cli = </span><span class="nx">require</span> <span class="s1">&#39;./cli&#39;</span>
<span class="nv">exports.cli = </span><span class="o">-&gt;</span>
  <span class="k">new</span> <span class="nx">Cli</span>

<span class="nv">Campfire = </span><span class="nx">require</span> <span class="s1">&#39;./campfire&#39;</span>
<span class="nv">exports.campfire = </span><span class="nf">(args...) -&gt;</span>
  <span class="k">new</span> <span class="nx">Campfire</span> <span class="nx">args</span><span class="p">...</span>

<span class="nv">Xmpp = </span><span class="nx">require</span> <span class="s1">&#39;./xmpp&#39;</span>
<span class="nv">exports.xmpp = </span><span class="nf">(args...) -&gt;</span>
  <span class="k">new</span> <span class="nx">Xmpp</span> <span class="nx">args</span><span class="p">...</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 